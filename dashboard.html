<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DACN - Smart Node</title>
    <style>
        :root { --h: #075e54; --bg: #efe7dd; --me: #d9fdd3; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header { background: var(--h); color: #fff; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; height: 60px; box-sizing: border-box; }
        .side-box { width: 100px; font-size: 10px; }
        .country-title { flex: 1; text-align: center; font-weight: bold; font-size: 18px; }
        .key-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 5px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; }
        .input-area { background: #f0f2f5; padding: 10px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #ddd; }
        input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        #chat { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 8px; margin-bottom: 10px; font-size: 14.5px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; }
        .msg-me { background: var(--me); align-self: flex-end; }
        .msg-other { background: #fff; align-self: flex-start; }
        .chat-img { width: 100%; max-width: 250px; border-radius: 6px; display: block; margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="header">
        <div class="side-box" id="storage-info">Checking Node...</div>
        <div class="country-title" id="node-name">DACN Node</div>
        <div class="side-box" style="text-align: right;"><button class="key-btn" onclick="copyKey()">ðŸ”‘ KEY</button></div>
    </div>

    <div class="input-area">
        <label style="cursor:pointer; font-size: 22px;">ðŸ“·<input type="file" id="file-input" hidden accept="image/*" onchange="uploadImage(this)"></label>
        <input type="text" id="inp" placeholder="à¦¬à¦¾à¦°à§à¦¤à¦¾ à¦²à¦¿à¦–à§à¦¨...">
        <button style="border:none; background:none; font-size:24px; color:var(--h); cursor:pointer;" onclick="send()">âž¤</button>
    </div>

    <div id="chat"></div>

    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script>
        let MY_KEY, MY_COUNTRY, db;
        let retry = 0;

        // à§§. à¦¸à¦¿à¦•à¦¿à¦‰à¦°à¦¿à¦Ÿà¦¿ à¦šà§‡à¦• (Retry Logic à¦¸à¦¹)
        function checkAccess() {
            MY_KEY = localStorage.getItem('p_key');
            MY_COUNTRY = localStorage.getItem('user_country');
            if (localStorage.getItem('setup_complete') === 'true' && MY_KEY) {
                document.getElementById('node-name').innerText = MY_COUNTRY;
                initApp();
            } else if (retry < 5) {
                retry++;
                setTimeout(checkAccess, 500); 
            } else {
                alert("à¦¸à§‡à¦Ÿà¦†à¦ª à¦ªà¦¾à¦“à§Ÿà¦¾ à¦¯à¦¾à§Ÿà¦¨à¦¿!");
                window.location.href = "index.html";
            }
        }

        // à§¨. à¦®à§‡à¦‡à¦¨ à¦…à§à¦¯à¦¾à¦ª à¦²à¦œà¦¿à¦•
        function initApp() {
            const gun = Gun(['https://gun-manhattan.herokuapp.com/gun', 'https://peer.wall.org/gun']);
            const network = gun.get('dacn_p2p_v10_final');

            // à¦¨à§‡à¦Ÿà¦“à§Ÿà¦¾à¦°à§à¦• à¦¥à§‡à¦•à§‡ à¦¡à¦¾à¦Ÿà¦¾ à¦°à¦¿à¦¸à¦¿à¦­
            network.map().on((data, id) => {
                if (data && data.content && !document.getElementById('msg-' + id)) {
                    renderMsg(data);
                    saveToNode(data); // à¦…à¦¨à§à¦¯ à¦‡à¦‰à¦œà¦¾à¦°à§‡à¦° à¦¡à¦¾à¦Ÿà¦¾ à¦¨à¦¿à¦œà§‡à¦° à¦«à§‹à¦¨à§‡ à¦¸à§‡à¦­ (Node support)
                }
            });

            // à§©. à¦®à§‡à¦¸à§‡à¦œ à¦ªà¦¾à¦ à¦¾à¦¨à§‹
            window.send = function() {
                const inp = document.getElementById('inp');
                const val = inp.value.trim();
                if (!val) return;
                const msgId = "MSG" + Date.now();
                network.get(msgId).put({
                    id: msgId, type: 'text', content: val, sender: MY_KEY, 
                    time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
                });
                inp.value = "";
            };

            // à§ª. à¦›à¦¬à¦¿ à¦ªà¦¾à¦ à¦¾à¦¨à§‹ (Sharding)
            window.uploadImage = function(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const msgId = "IMG" + Date.now();
                        network.get(msgId).put({
                            id: msgId, type: 'image', content: e.target.result, sender: MY_KEY,
                            time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
                        });
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            };
        }

        // à§«. à¦¡à¦¿à¦¸à§à¦Ÿà§à¦°à¦¿à¦¬à¦¿à¦‰à¦Ÿà§‡à¦¡ à¦¸à§à¦Ÿà§‹à¦°à§‡à¦œ (IndexedDB)
        const request = indexedDB.open("DACN_Storage", 1);
        request.onupgradeneeded = (e) => e.target.result.createObjectStore("msgs", { keyPath: "id" });
        request.onsuccess = (e) => {
            db = e.target.result;
            updateStorageUI();
        };

        function saveToNode(data) {
            if (!db) return;
            const tx = db.transaction("msgs", "readwrite");
            tx.objectStore("msgs").put(data);
            updateStorageUI();
        }

        async function updateStorageUI() {
            if (navigator.storage && navigator.storage.estimate) {
                const est = await navigator.storage.estimate();
                const used = (est.usage / (1024 * 1024)).toFixed(1);
                document.getElementById('storage-info').innerText = used + "MB / 200MB";
                
                if (est.usage > 200 * 1024 * 1024) {
                    const tx = db.transaction("msgs", "readwrite");
                    const store = tx.objectStore("msgs");
                    store.openCursor().onsuccess = (e) => {
                        const cursor = e.target.result;
                        if (cursor) store.delete(cursor.key); 
                    };
                }
            }
        }

        function renderMsg(data) {
            if (document.getElementById('msg-' + data.id)) return;
            const d = document.createElement('div');
            d.id = 'msg-' + data.id;
            d.className = 'msg ' + (data.sender === MY_KEY ? 'msg-me' : 'msg-other');
            d.innerHTML = data.type === 'text' ? data.content : `<img src="${data.content}" class="chat-img">`;
            d.innerHTML += `<div style="font-size:9px; text-align:right; margin-top:4px; opacity:0.6;">${data.time}</div>`;
            document.getElementById('chat').prepend(d);
        }

        function copyKey() {
            navigator.clipboard.writeText(MY_KEY);
            alert("à¦•à¦¿ à¦•à¦ªà¦¿ à¦¹à§Ÿà§‡à¦›à§‡!");
        }

        checkAccess();
    </script>
</body>
</html>
