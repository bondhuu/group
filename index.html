<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DACN - Peer Node v2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #0a0a0a; color: #00ff88; margin: 0; padding: 15px; }
        .app-card { background: #161616; border: 1px solid #333; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h2 { margin-top: 0; text-align: center; color: #fff; text-transform: uppercase; letter-spacing: 2px; }
        .info { background: #222; padding: 10px; border-radius: 8px; font-size: 13px; color: #aaa; margin-bottom: 15px; }
        #my-id { color: #00ff88; font-weight: bold; word-break: break-all; }
        #log-window { height: 200px; background: #000; border: 1px solid #222; border-radius: 8px; overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px; color: #00ccff; margin-bottom: 15px; }
        .input-box { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; outline: none; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 8px; transition: 0.3s; }
        .btn-connect { background: #007bff; color: white; }
        .btn-send { background: #00ff88; color: #000; }
        .btn-read { background: #ffcc00; color: #000; }
        .shard-item { border-bottom: 1px solid #333; padding: 5px 0; }
    </style>
</head>
<body>

<div class="app-card">
    <h2>DACN Node</h2>
    <div class="info">নোড আইডি: <span id="my-id">জেনারেট হচ্ছে...</span></div>
    
    <div id="log-window">-- সিস্টেম স্ট্যাটাস: অনলাইন --<br></div>

    <input type="text" id="target-id" class="input-box" placeholder="বন্ধুর আইডি দিন (Connect)">
    <button class="btn btn-connect" onclick="connect()">কানেক্ট করুন</button>

    <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">

    <input type="text" id="secret-msg" class="input-box" placeholder="গোপন মেসেজ লিখুন...">
    <button class="btn btn-send" onclick="shardAndDistribute()">শার্ড করে ছড়িয়ে দিন</button>
    <button class="btn btn-read" onclick="readFullData()">তথ্য উদ্ধার করুন</button>
</div>

<script>
    let peer, conn_list = [], db;

    // ১. IndexedDB (ব্রাউজার স্টোরেজ) চালু করা
    const dbReq = indexedDB.open("DACN_v2", 1);
    dbReq.onupgradeneeded = e => e.target.result.createObjectStore("shards", { keyPath: "id", autoIncrement: true });
    dbReq.onsuccess = e => { 
        db = e.target.result;
        addToLog("সিস্টেম: লোকাল স্টোরেজ প্রস্তুত।");
    };

    // ২. PeerJS নোড সেটআপ
    function startNode() {
        peer = new Peer();

        peer.on('open', id => {
            document.getElementById('my-id').innerText = id;
            addToLog("সিস্টেম: আপনার নোড সফলভাবে চালু হয়েছে।");
        });

        peer.on('connection', c => {
            addToLog(`কানেকশন: ${c.peer} আপনার সাথে যুক্ত হয়েছে।`);
            setupConn(c);
        });

        peer.on('error', err => {
            addToLog(`এরর: ${err.type}`);
            console.error(err);
        });
    }

    function connect() {
        const id = document.getElementById('target-id').value;
        if (!id) return alert("আইডি দিন!");
        const c = peer.connect(id);
        setupConn(c);
    }

    function setupConn(c) {
        c.on('open', () => {
            if (!conn_list.find(x => x.peer === c.peer)) {
                conn_list.push(c);
                addToLog(`সফল: ${c.peer}-এর সাথে কানেক্টেড।`);
            }
            c.on('data', data => {
                saveData(data);
                addToLog(`রিসিভ: একটি নতুন ডাটা শার্ড এসেছে।`);
            });
        });
    }

    // ৩. ডাটা শার্ডিং এবং ১০০০ কপি লজিক (সিমুলেশন)
    function shardAndDistribute() {
        const text = document.getElementById('secret-msg').value;
        if (!text) return;
        if (conn_list.length === 0) return alert("আগে অন্তত একজনকে কানেক্ট করুন!");

        const msgId = Date.now();
        const totalNodes = conn_list.length + 1;
        const shardSize = Math.ceil(text.length / totalNodes);

        for (let i = 0; i < totalNodes; i++) {
            let part = text.substring(i * shardSize, (i + 1) * shardSize);
            let encrypted = btoa(part); // Base64 এনক্রিপশন (হিজিবিজি কোড)
            let shard = { msgId, order: i, data: encrypted };

            if (i === 0) saveData(shard); // নিজের জন্য রাখা
            
            // নেটওয়ার্কের সবার কাছে কপি পাঠানো (Redundancy)
            conn_list.forEach(c => c.send(shard));
        }
        document.getElementById('secret-msg').value = "";
        addToLog("সফল: ডাটা শার্ড করে নেটওয়ার্কে ছড়ানো হয়েছে।");
    }

    // ৪. স্টোরেজ এবং রিড ফাংশন
    function saveData(obj) {
        const tx = db.transaction("shards", "readwrite");
        tx.objectStore("shards").add(obj);
    }

    function readFullData() {
        const tx = db.transaction("shards", "readonly");
        tx.objectStore("shards").getAll().onsuccess = e => {
            const all = e.target.result;
            if (all.length === 0) return alert("কোনো ডাটা নেই!");

            // লেটেস্ট মেসেজ জোড়া লাগানো
            const lastId = all[all.length-1].msgId;
            let parts = all.filter(x => x.msgId === lastId)
                           .sort((a,b) => a.order - b.order);
            
            // ডুপ্লিকেট রিমুভ (Redundancy handling)
            let unique = [...new Map(parts.map(p => [p.order, p])).values()];

            try {
                let finalMsg = unique.map(u => atob(u.data)).join('');
                alert("উদ্ধারকৃত মেসেজ: " + finalMsg);
            } catch(e) { alert("ডাটা ইনকমপ্লিট!"); }
        };
    }

    function addToLog(txt) {
        const win = document.getElementById('log-window');
        win.innerHTML += `> ${txt}<br>`;
        win.scrollTop = win.scrollHeight;
    }

    // অ্যাপ চালু করা
    startNode();
</script>

</body>
</html>
