<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Secure P2P Chat - Final Fix</title>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{
    font-family:'Segoe UI',sans-serif;
    background:#e5ddd5;
    margin:0;
    display:flex;
    flex-direction:column;
    height: 100vh;
    overflow: hidden;
}

#header{
    background:#075e54;
    color:white;
    padding:12px;
    display:flex;
    align-items:center;
    position:sticky;
    top:0;
    z-index:1000;
}
#room-info{font-size:14px;font-weight:bold;flex:1;display:flex;align-items:center;gap:8px;}
#status-dot{width:10px;height:10px;background:#ff4d4d;border-radius:50%; transition: 0.3s;}

#chat-container{
    flex:1;
    overflow-y:auto;
    padding:12px;
    padding-bottom: 20px; /* নিচের মেসেজের জন্য জায়গা */
    display:flex;
    flex-direction:column;
    gap:8px;
}

/* মেসেজ যাতে ইনপুট বক্সের নিচে না যায় */
#scroll-buffer { height: 100px; flex-shrink: 0; }

.msg-wrapper { display: flex; width: 100%; }
.mine-wrapper { justify-content: flex-end; }
.others-wrapper { justify-content: flex-start; }

.msg {
    display: table;
    max-width: 80%;
    padding: 7px 11px;
    border-radius: 12px;
    font-size: 14px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    word-wrap: break-word;
    white-space: pre-wrap;
    line-height: 1.4;
}

.mine { background:#dcf8c6; border-top-right-radius: 2px; }
.others { background:white; border-top-left-radius: 2px; }

.sender { font-size:11px; font-weight:bold; color:#128c7e; margin-bottom:2px; cursor:pointer; }
.user-tag { color:#888; font-size:9px; font-weight: normal; }
.time { font-size:9px; color:#888; text-align:right; margin-top:3px; display: block; }

#input-area{
    background:#075e54;
    padding:8px 12px;
    display:flex;
    gap:8px;
    position:fixed;
    bottom:0;
    width:100%;
    align-items: center;
}
#message-input{ flex:1; border-radius:20px; border:none; padding:10px 15px; font-size:15px; outline: none; }
#send-btn{ background:#128c7e; color:white; border:none; border-radius:50%; width:44px; height:44px; font-size:20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

#setup-box{
    position:fixed;
    inset:0;
    background:#075e54;
    color:white;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:2000;
    gap:12px;
    padding: 20px;
}
#setup-box input{ width:100%; max-width:300px; padding:12px; border-radius:25px; border:none; text-align:center; outline: none; }
#setup-box button{ padding:12px 35px; background:#128c7e; color:white; border:none; border-radius:25px; font-weight:bold; cursor: pointer; }
</style>
</head>

<body>

<div id="setup-box">
    <h2>Secure Chat</h2>
    <input id="user-name" placeholder="Your Name">
    <input id="room-pass" placeholder="Room Password">
    <button onclick="startChat()">Join Chat</button>
</div>

<div id="header">
    <div id="room-info"><div id="status-dot"></div> Room: Connecting...</div>
</div>

<div id="chat-container">
    <div id="msg-list"></div>
    <div id="scroll-buffer"></div> </div>

<div id="input-area">
    <input id="message-input" placeholder="Type message...">
    <button id="send-btn" onclick="sendMessage()">➔</button>
</div>

<script>
const firebaseConfig={
    apiKey:"AIzaSyDZ0i_k2IFXOcXeGwrD2tZWQJvR0_Ztgd8",
    authDomain:"group-e14e4.firebaseapp.com",
    databaseURL:"https://group-e14e4-default-rtdb.firebaseio.com",
    projectId:"group-e14e4"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let peer,myName,roomPass,myTag;
let connections={},chatHistory=[];

function escapeHTML(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function updateStatus(isConnected) {
    document.getElementById('status-dot').style.background = isConnected ? "#00ff00" : "#ff4d4d";
}

function startChat(){
    myName=document.getElementById('user-name').value.trim();
    roomPass=document.getElementById('room-pass').value.trim();
    if(!myName||!roomPass)return alert("Fill all fields");
    myTag="#"+Math.floor(Math.random()*9000+1000);
    document.getElementById('setup-box').style.display="none";
    document.getElementById('room-info').innerHTML=`<div id="status-dot"></div> Room: ${roomPass}`;

    peer=new Peer();
    peer.on('open',id=>{
        const ref=db.ref("rooms/"+roomPass+"/"+id);
        ref.set({id,name:myName,tag:myTag});
        ref.onDisconnect().remove();
        
        db.ref("rooms/"+roomPass).on("value",snap=>{
            const u=snap.val()||{};
            let userCount = 0;
            for(let k in u) {
                if(k!==id&&!connections[k]) setupConn(peer.connect(k));
                userCount++;
            }
            // যদি অন্তত একজন ইউজার থাকে তবে সবুজ হবে
            updateStatus(Object.keys(connections).length > 0 || userCount > 1);
        });
    });
    peer.on('connection', setupConn);
}

function setupConn(conn){
    conn.on('open',()=>{
        connections[conn.peer]=conn;
        updateStatus(true);
    });
    conn.on('data',d=>saveMsg(d,d.sender===myName?'mine':'others'));
    conn.on('close', () => {
        delete connections[conn.peer];
        if(Object.keys(connections).length === 0) updateStatus(false);
    });
}

function sendMessage(){
    const input=document.getElementById('message-input');
    if(!input.value.trim())return;
    const msg={mid:Date.now(),sender:myName,tag:myTag,text:input.value,time:new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})};
    for(let k in connections)connections[k].send(msg);
    saveMsg(msg,'mine');
    input.value='';
}

function saveMsg(msg,type){
    msg.msgType=type;
    chatHistory.push(msg);
    renderAll();
}

function renderAll(){
    const list=document.getElementById('msg-list');
    list.innerHTML='';
    chatHistory.forEach(m=>{
        const wrapper = document.createElement('div');
        wrapper.className = `msg-wrapper ${m.msgType === 'mine' ? 'mine-wrapper' : 'others-wrapper'}`;
        
        const d=document.createElement('div');
        d.className=`msg ${m.msgType}`;
        d.innerHTML=`<div class="sender">${escapeHTML(m.sender)} <span class="user-tag">${m.tag}</span></div>
        <div style="word-break: break-all;">${escapeHTML(m.text)}</div><span class="time">${m.time}</span>`;
        
        wrapper.appendChild(d);
        list.appendChild(wrapper);
    });
    
    // ✅ অটো স্ক্রল ফিক্স
    const container = document.getElementById('chat-container');
    container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
}

document.getElementById('message-input').addEventListener('keypress',e=>{if(e.key==="Enter")sendMessage();});
</script>
</body>
</html>
