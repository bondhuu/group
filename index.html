<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DACN - Decentralized Storage Node</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #121212; color: #e0e0e0; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: #1e1e1e; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        h2 { color: #00ff88; text-align: center; }
        #node-id { background: #333; padding: 5px 10px; border-radius: 5px; color: #ffcc00; font-family: monospace; }
        .status-box { font-size: 14px; margin: 10px 0; color: #bbb; }
        #chat-window { height: 250px; border: 1px solid #444; background: #000; overflow-y: auto; padding: 10px; border-radius: 8px; margin: 15px 0; }
        .msg-shard { font-size: 12px; color: #666; font-family: monospace; word-break: break-all; border-bottom: 1px solid #222; margin-bottom: 5px; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }
        button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-connect { background: #007bff; color: white; }
        .btn-send { background: #00ff88; color: #000; width: 100%; }
        .btn-read { background: #ffcc00; color: #000; margin-top: 10px; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <h2>DACN NODE</h2>
    <p class="status-box">আপনার নোড আইডি: <span id="node-id">লোডিং...</span></p>
    <p class="status-box">অনলাইন বন্ধু: <span id="peer-count">0</span> জন</p>
    
    <div class="input-group">
        <input type="text" id="friend-id" placeholder="বন্ধুর আইডি দিন">
        <button class="btn-connect" onclick="connectToFriend()">Connect</button>
    </div>

    <div id="chat-window">
        <div style="color: #888; text-align: center;">-- সংরক্ষিত ডেটা শার্ডস (Shards) --</div>
    </div>

    <input type="text" id="main-input" placeholder="আপনার গোপন তথ্য লিখুন...">
    <button class="btn-send" onclick="sendSecureData()">তথ্যটি টুকরো করে ছড়িয়ে দিন</button>
    <button class="btn-read" onclick="assembleAndShow()">তথ্য উদ্ধার করে পড়ুন</button>
</div>

<script>
    let peer = new Peer();
    let connections = [];
    let db;

    // ১. IndexedDB সেটআপ (লোকাল স্টোরেজ)
    const request = indexedDB.open("DACN_Storage", 1);
    request.onupgradeneeded = e => {
        db = e.target.result;
        db.createObjectStore("shards", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = e => {
        db = e.target.result;
        renderStoredShards();
    };

    // ২. পিয়ার কানেকশন লজিক
    peer.on('open', id => document.getElementById('node-id').innerText = id);
    peer.on('connection', conn => handleConnection(conn));

    function connectToFriend() {
        const id = document.getElementById('friend-id').value;
        if(id) handleConnection(peer.connect(id));
    }

    function handleConnection(conn) {
        conn.on('open', () => {
            if(!connections.find(c => c.peer === conn.peer)) {
                connections.push(conn);
                document.getElementById('peer-count').innerText = connections.length;
            }
            conn.on('data', data => {
                saveShard(data);
                renderStoredShards();
            });
        });
    }

    // ৩. শার্ডিং এবং ডিস্ট্রিবিউশন (Sharding & Distribution)
    function sendSecureData() {
        const text = document.getElementById('main-input').value;
        if(!text) return;

        const peerCount = connections.length + 1;
        const shardSize = Math.max(1, Math.ceil(text.length / peerCount));
        const msgId = Date.now();

        for (let i = 0; i < peerCount; i++) {
            let part = text.substring(i * shardSize, (i + 1) * shardSize);
            // হিজিবিজি কোড (Base64 Encryption)
            let encryptedPart = btoa(part);
            
            let shardObj = { msgId: msgId, order: i, data: encryptedPart, total: peerCount };

            // নিজের ফোনে সেভ করা
            if(i === 0) saveShard(shardObj);

            // নেটওয়ার্কের সবার কাছে কপি পাঠানো (Redundancy)
            connections.forEach(conn => conn.send(shardObj));
        }
        document.getElementById('main-input').value = "";
        alert("তথ্যটি সফলভাবে শার্ড করা হয়েছে এবং কপি ছড়িয়ে দেওয়া হয়েছে!");
        renderStoredShards();
    }

    // ৪. স্টোরেজ লজিক
    function saveShard(obj) {
        const tx = db.transaction("shards", "readwrite");
        tx.objectStore("shards").add(obj);
    }

    function renderStoredShards() {
        const chatWindow = document.getElementById('chat-window');
        chatWindow.innerHTML = "";
        const tx = db.transaction("shards", "readonly");
        tx.objectStore("shards").openCursor().onsuccess = e => {
            const cursor = e.target.result;
            if (cursor) {
                chatWindow.innerHTML += `<div class="msg-shard">Shard_ID: ${cursor.value.msgId} | Data: ${cursor.value.data}</div>`;
                cursor.continue();
            }
        };
    }

    // ৫. ডাটা অ্যাসেম্বল (পুনরুদ্ধার)
    function assembleAndShow() {
        const tx = db.transaction("shards", "readonly");
        let allShards = [];
        tx.objectStore("shards").getAll().onsuccess = e => {
            allShards = e.target.result;
            
            // আইডি অনুযায়ী গ্রুপ করা (যেহেতু অনেক মেসেজ থাকতে পারে)
            const latestMsgId = allShards[allShards.length - 1]?.msgId;
            const relevantShards = allShards.filter(s => s.msgId === latestMsgId);

            // ডুপ্লিকেট বাদ দিয়ে সাজানো
            relevantShards.sort((a, b) => a.order - b.order);
            let uniqueParts = [...new Map(relevantShards.map(item => [item.order, item])).values()];

            try {
                let decrypted = uniqueParts.map(p => atob(p.data)).join('');
                alert("উদ্ধারকৃত মূল তথ্য: " + decrypted);
            } catch(err) {
                alert("তথ্যটি পূর্ণাঙ্গ নয় অথবা ডিক্রিপ্ট করা যাচ্ছে না!");
            }
        };
    }
</script>

</body>
</html>
